% !TeX root = ../main.tex

% Copyright (c) 2022 myl7
% SPDX-License-Identifier: CC-BY-NC-ND-4.0

\chapter{缺陷与改进}

\section{TCP 碎片伪装为 TCP 连接}

如上述测试与分析章节的功能测试部分指出的，本项目目前伪装出的 TCP 流量呈现为 TCP 碎片。
尽管常见检测方式会将这些 TCP 碎片检测为 TCP 流量，但在通过能处理连接状态的网络流量过滤设备，如带 conntrack 的防火墙时，TCP 碎片会被探测为无效的 TCP 流量而被丢弃。
为了此情况的出现，一个可行的方案是进一步将 TCP 碎片伪装为 TCP 连接。
我们已经设计好了一个完善的解决方案：
为了让这些 TCP 碎片被识别为一个 TCP 连接，在前述设计方案考虑了更改 TCP 头部序列号字段这一操作的前提下，只需通过 eBPF 的持久化手段 maps、将 TCP 碎片的序列号字段排列为连续值即可。
除此之外，还需要伪造开启 TCP 连接的 SYN、ACK-SYN、ACK 三个请求，从而伪装出 TCP 连接创建的过程。
但在此方案下，由于 eBPF 中 maps 持久化方案体现为一个全局的 \texttt{struct} 变量，通过相应的 maps API 进行读写。
而当此程序代码同时运行在多个 CPU 核心上时，同一个 maps 全局变量可能会被多个内核线程同时访问，因而需要加锁或是使用原子操作，进而影响程序的吞吐量。
为了解决这种情况，我们可以使用 maps API 提供的另一套持久化方案，其允许不同内核线程的代码在访问代码中同一个 maps 全局变量时实际访问到不同的数据。
此时，此程序维护与 CPU 核心相同数量的 maps 全局变量和 TCP 连接，不同 TCP 连接使用不同的 TCP 头部序列号序列，从而无需使用锁，维持了程序的吞吐量。

\section{eBPF 生态}

本项目基于 eBPF 实现了核心功能，也使得 eBPF 及其相关生态的问题成为了本项目问题的一部分。
尽管 eBPF 基础功能已经基本完善，但其周边设施依然需要改进和增强，例如 eBPF 相关程序缺少开机启动和后台服务管理的成套设施。
目前 eBPF 周边生态的开发依然主要着眼于实现基础功能的命令行工具，这一方面是 eBPF 新特性不断涌现且随着 Linux 内核版本更新而扩大支持设备范围导致的，另一方面 eBPF 的影响力尚且不足，在缺少大公司支持、依靠开源生态推广的情况下难以吸引到足够的周边设施开发者。
如果需要进一步推广本项目，甚至投入到实用中，周边工具的开发还有待精力投入。
